<?php
// =======================================
// üì¨ FORMULARIO DE CONTACTO NOSTRADAMUS
// =======================================

$to = "informes@gruponostradamus.edu.pe";
$fromEmail = "web@gruponostradamus.edu.pe";      // Debe existir en tu hosting
$fromName  = "Web Nostradamus";

if ($_SERVER["REQUEST_METHOD"] === "POST") {
    // 1) Sanear datos
    $name   = trim(strip_tags($_POST["name"]   ?? ''));
    $email  = trim($_POST["email"]  ?? '');
    $number = trim(strip_tags($_POST["number"] ?? ''));
    $course = trim(strip_tags($_POST["course"] ?? ''));

    // 2) Validaciones
    if ($name === '' || $email === '' || !filter_var($email, FILTER_VALIDATE_EMAIL)) {
        http_response_code(400);
        echo "Por favor completa tu nombre y un correo v√°lido.";
        exit;
    }

    // 3) Asunto codificado (soporta emoji)
    $subjectRaw = "üì© Nuevo mensaje desde la web de Nostradamus";
    $subject = '=?UTF-8?B?' . base64_encode($subjectRaw) . '?=';

    // 4) Cuerpo HTML
    $body = "
    <html><body style='font-family: Arial, sans-serif; color:#333;'>
        <h2>Nuevo mensaje desde la web</h2>
        <p><strong>Nombre:</strong> " . htmlspecialchars($name, ENT_QUOTES, 'UTF-8') . "</p>
        <p><strong>Correo:</strong> " . htmlspecialchars($email, ENT_QUOTES, 'UTF-8') . "</p>
        <p><strong>Tel√©fono:</strong> " . htmlspecialchars($number, ENT_QUOTES, 'UTF-8') . "</p>
        <p><strong>Curso:</strong> " . htmlspecialchars($course, ENT_QUOTES, 'UTF-8') . "</p>
        <hr>
        <p style='font-size:12px;color:#777;'>Enviado autom√°ticamente desde gruponostradamus.edu.pe</p>
    </body></html>";

    // 5) Cabeceras
    $headers  = "MIME-Version: 1.0\r\n";
    $headers .= "Content-Type: text/html; charset=UTF-8\r\n";
    $headers .= "From: {$fromName} <{$fromEmail}>\r\n";
    $headers .= "Reply-To: {$name} <{$email}>\r\n";
    $headers .= "Return-Path: {$fromEmail}\r\n"; // visible para algunos servidores

    // 6) Envelope sender (-f) ayuda a pasar SPF/DMARC
    $envelopeSender = "-f {$fromEmail}";

    // 7) Enviar
    $ok = @mail($to, $subject, $body, $headers, $envelopeSender);

    if ($ok) {
        echo "‚úÖ ¬°Mensaje enviado correctamente! Te responderemos pronto.";
    } else {
        http_response_code(500);
        echo "‚ùå Error al enviar el mensaje. Intenta nuevamente m√°s tarde.";
    }
} else {
    http_response_code(403);
    echo "Acceso no permitido.";
}
